---
sidebar_position: 2
title: åŠ è½½å¤©åœ°å›¾
description: åŠ è½½å¤©åœ°å›¾ç›¸å…³
date: 2024-6-26

tags: [arcgis for js3,arcgis for js4, gis, tile,]
---


## ä¸€ã€arcgis js3x åŠ è½½å¤©åœ°å›¾æ—¶, å¦‚ä½•æ·»åŠ è¯·æ±‚å¤´?

### æ€è·¯

#### 1

googleä¹‹åå‘ç° `esriConfig.request.interceptors.push(interceptor);`ã€‚
è¯•äº†å‘ç°åªæœ‰ **arcgis for js4**èƒ½ç”¨å®ƒã€‚

#### 2  
googleå¼€å§‹æœ **arcgis for js3**,å‘ç° `esriRequestÂ·setRequestPreCa11back`ã€‚
è¯•äº†å‘ç°æ ¹æœ¬ä¸è¿›è¿™ä¸ªæ–¹æ³•é‡Œã€‚

#### 3 

çœ‹çœ‹è°åœ¨è°ƒç”¨å¤©åœ°å›¾çš„è¯·æ±‚ã€‚  
![æ˜¯è°](./img/arcgis/whoGetTdt.png)

æ˜¯æºç ä¸­çš„ `_addImage` ä¸­åˆ›å»ºäº† `img = new Image();img.src = h`, æ‰€ä»¥æ˜¯imgæ ‡ç­¾å»è¯·æ±‚çš„å¤©åœ°å›¾ã€‚  

(hå°±æ˜¯å¤©åœ°å›¾çš„è¯·æ±‚åœ°å€ï¼Œè¿™ä¸ªåœ°å€ä¼šå»æˆ‘ä»¬å°è£…çš„å¤©åœ°å›¾ç±»çš„`getTileUrl` æ‹¿ã€‚)  


æˆ‘ç¼“ç¼“åœ¨googleä¸­æ‰“å‡ºäº†ä¸€è¡Œå­— ã€‚ã€‚ã€‚  

**imgæ ‡ç­¾çš„srcæ²¡æ³•è®¾ç½®è¯·æ±‚å¤´å—ï¼Ÿ**  

#### 4  

é‚£æˆ‘è¯·æ±‚ä¸‹æ¥å¤©åœ°å›¾åï¼Œè¿”å›ç»™æºç ä¸­çš„ `_addImage` çš„ `img.src`å’¯

ä¸€é¡¿ `xhr`åï¼Œå‘ç°å¼‚æ­¥æ‰èƒ½æ‹¿åˆ°ç»“æœå•Šã€‚ä½†æ˜¯ `_addImage`æ˜¯åŒæ­¥çš„ï¼

æˆ‘ç”šè‡³å¼€å§‹æƒ³æˆ‘åº”è¯¥æ€ä¹ˆé­”æ”¹ä¸€ä¸‹æºç çš„`_addImage`æ–¹æ³•ã€‚  

#### 5  

çªç„¶çµå…‰ä¹ç°  

```js
getTileUrl: function (level, row, col, element){}
```

è¿™ä¸æ˜¯ç°æˆçš„ elementå—?????



### ä»£ç 
```js 
// oldï¼šç›´æ¥æŠŠè¯·æ±‚åœ°å€è¿”å›ç»™æºç å’¯
getTileUrl: function (level, row, col, element) {
    return  this._urlTemplate.replace('{z}', level).replace('{x}', col).replace('{y}', row);
}
// newï¼šæˆ‘è‡ªå·±å†™è¯·æ±‚ï¼Œæœ€åå¼‚æ­¥æ‹¿åˆ°ç»“æœå¤åˆ¶ç»™element
getTileUrl: function (level, row, col, element) {
    const uu = this._urlTemplate.replace('{z}', level).replace('{x}', col).replace('{y}', row);
      // ä½¿ç”¨ XMLHttpRequest è¿›è¡Œè‡ªå®šä¹‰è¯·æ±‚
      var xhr = new XMLHttpRequest();
      xhr.open('GET', uu, true);
      xhr.responseType = 'blob';
      xhr.setRequestHeader("aaa", "aaa");
      
      xhr.onload = () => {
          if (xhr.status === 200) {
              var reader = new FileReader();
              reader.onloadend = () => {
                  var base64data = reader.result;
                  element.src = base64data
              };
              reader.readAsDataURL(xhr.response);
          }
      };

      xhr.send();
}

```


:::tip çŸ¥è¯†ç‚¹

### 1. å®˜æ–¹æ–‡æ¡£ä¸­gettileurlå¹¶æ²¡æœ‰ç¬¬å››ä¸ªå‚æ•°, ä½†æ˜¯æºç é‡Œä¼ äº†çš„ã€‚

å®ƒæ˜¯imgæ ‡ç­¾ã€‚  

![æ˜¯è°](./img/arcgis/gettileurl.png)
     

:::

### å‚è€ƒ
[å‚è€ƒï¼šarcgis js3çš„å®˜æ–¹æ–‡æ¡£gettileurl](https://developers.arcgis.com/javascript/3/jsapi/tiledmapservicelayer-amd.html#gettileurl)

---





## äºŒã€å¤©åœ°å›¾çš„ tileInfo.lods ä»å“ªé‡Œæ‹¿?  

### lodséœ€è¦çš„æ•°æ®  

level: ç¼©æ”¾çº§åˆ«  
scale: ç¼©æ”¾çº§åˆ«å¯¹åº”çš„æ¯”ä¾‹å°ºé™¤æ•°  
resolution   


### å¤©åœ°å›¾ GetCapabilities  

[å‚è€ƒï¼šå¤©åœ°å›¾ GetCapabilities ](https://t0.tianditu.gov.cn/img_c/wmts?request=GetCapabilities&service=wmts)  

ğŸ‘†å¯ä»¥çœ‹å¤©åœ°å›¾çš„TileMatrixSetï¼š4490ã€18ä¸ªç¼©æ”¾çº§åˆ«ã€æ¯ä¸ªçº§åˆ«çš„ ScaleDenominatorã€‚  

***è¿™é‡Œæ²¡æœ‰resolution***     
 

### è®¡ç®— resolution?      

#### ~~ç½‘ä¸Šæœ‰ä¸€ä¸ªå…¬å¼æ¥ç®—~~  

ç½‘ä¸Šæœ‰ä¸€ä¸ªå…¬å¼è®¡ç®—resolutionï¼Œè¦ç”¨åˆ° scaleã€dpiã€è‹±å°ºå’Œç±³çš„ç™¾åˆ†æ¯”...   

æ‰€ä»¥æ˜¯å¯ä»¥ç”¨æ¯ä¸€çº§çš„ScaleDenominator å’Œ å…¶å®ƒå¸¸æ•°æ¥è®¡ç®—å‡ºä¸€ä¸ªresolutionã€‚  


ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå¤©åœ°å›¾GetCapabilitiesä¸­ç»™çš„æ¯ä¸€çº§çš„ScaleDenominatoræ˜¯åŠ å¯†æœ‰åç§»çš„ã€‚  

æ‰€ä»¥ä½ æœ€ç»ˆç®—åˆ°çš„æ•°ä¹Ÿæ˜¯ä¸å¯¹çš„ã€‚ 

é™¤éç»™ä½ æä¾›è§£å¯†å…¬å¼ã€‚      


#### å¯¹ç€geoserverå‘å¸ƒçš„4490gridsetæ¥æ‹¿å’¯   

ğŸ‘‡å¯ä»¥çœ‹å‡ºæ¥å¤©åœ°å›¾çš„lodså’Œ4490çš„lodså·®ä¸€çº§     

![tdt lods](./img/geoserver/åŠ è½½wmts/lodstdt.png)
![4490 lods](./img/geoserver/åŠ è½½wmts/lods4490.png)


æ‰€ä»¥tdtdelodså¯ä»¥ç…§ç€geoseverä¸Š4490çš„å†™å’¯ã€‚åªè¦å·®ä¸€çº§å†™å°±è¡Œäº†ã€‚  



### æœ€ç»ˆ lods  

```js title="tdt.js"
export const lods = [
  {
      level: 2,
      resolution: 0.3515625,
      scale: 139770566.00717944
  },
  {
      level: 3,
      resolution: 0.17578125,
      scale: 69885283.00358972
  },
  {
      level: 4,
      resolution: 0.087890625,
      scale: 34942641.50179486
  },
  {
      level: 5,
      resolution: 0.0439453125,
      scale: 17471320.75089743
  },
  {
      level: 6,
      resolution: 0.02197265625,
      scale: 8735660.375448715
  },
  {
      level: 7,
      resolution: 0.010986328125,
      scale: 4367830.1877243575
  },
  {
      level: 8,
      resolution: 0.0054931640625,
      scale: 2183915.0938621787
  },
  {
      level: 9,
      resolution: 0.00274658203125,
      scale: 1091957.5469310894
  },
  {
      level: 10,
      resolution: 0.001373291015625,
      scale: 545978.7734655447
  },
  {
      level: 11,
      resolution: 0.0006866455078125,
      scale: 272989.38673277234
  },
  {
      level: 12,
      resolution: 0.0003433227539062,
      scale: 136494.69336636632
  },
  {
      level: 13,
      resolution: 0.0001716613769531,
      scale: 68247.34668318316
  },
  {
      level: 14,
      resolution: 0.0000858306884766,
      scale: 34123.67334161145
  },
  {
      level: 15,
      resolution: 0.0000429153442383,
      scale: 17061.836670805726
  },
  {
      level: 16,
      resolution: 0.0000214576721191,
      scale: 8530.918335382985
  },
  {
      level: 17,
      resolution: 0.0000107288360596,
      scale: 4265.45916771137
  },
  // {
  //     level: 18,
  //     resolution: 0.0000053644180298,
  //     scale: 2132.729583855685
  // },
  // {
  //     level: 19,
  //     resolution: 0.0000026822090149,
  //     scale: 1066.3647919278426
  // },

];


export default {
  // dpi: 96,
  rows: 256,
  cols: 256,
  compressionQuality: 0,
  origin: {
      x: -180,
      y: 90,
  },
  spatialReference: {
      wkid: 4490
  },
  lods,
}
```


### çŸ¥è¯†ç‚¹  

:::tip çŸ¥è¯†ç‚¹

#### 1. resolution  

1. resolutionï¼š1åƒç´ ä»£è¡¨çš„å®é™…è·ç¦»ã€‚    

2. å¦ä¸€ç§è®¡ç®—æ–¹å¼ï¼š 

æ‹¿xè½´æ¥ç®—ï¼š x/(256*2^level)  

ç»åº¦360Â°ï¼Œç“¦ç‰‡å¤§å°æ˜¯256ï¼Œ

ä¾‹å¦‚ï¼šå±‚çº§0ä½¿ç”¨äº†ä¸€ä¸ªç“¦ç‰‡ï¼Œå±‚çº§1ä½¿ç”¨äº†4ä¸ªç“¦ç‰‡ã€‚å±‚çº§0å’Œå±‚çº§1è¡¨ç¤ºçš„åœ°çƒèŒƒå›´éƒ½æ˜¯ä¸€æ ·çš„ç»åº¦[-180, 180]ï¼Œçº¬åº¦[-90, 90]ã€‚
åœ¨å±‚çº§0çš„æ—¶å€™ï¼Œä¸€ä¸ªåƒç´ å°±è¡¨ç¤º360/256 = 1.40625è¿™ä¹ˆé•¿çš„ç»åº¦èŒƒå›´ï¼Œè¿™ä¸ªæ•°å°±æ˜¯åˆ†è¾¨ç‡ï¼Œå³ä¸€ä¸ªåƒç´ æ‰€è¡¨ç¤ºçš„èŒƒå›´æ˜¯å¤šå°‘ã€‚


```md title="è®¡ç®—resolution"
TileMatrixSet>
    <ows:Identifier>c</ows:Identifier>
    <ows:SupportedCRS>urn:ogc:def:crs:EPSG::4490</ows:SupportedCRS>
    <TileMatrix>
        <ows:Identifier>1</ows:Identifier>
        <ScaleDenominator>2.958293554545656E8</ScaleDenominator>
        <TopLeftCorner>90.0 -180.0</TopLeftCorner>
        <TileWidth>256</TileWidth>
        <TileHeight>256</TileHeight>
        <MatrixWidth>2</MatrixWidth>
        <MatrixHeight>1</MatrixHeight>
    </TileMatrix>
    <TileMatrix>
        <ows:Identifier>2</ows:Identifier>
        <ScaleDenominator>1.479146777272828E8</ScaleDenominator>
        <TopLeftCorner>90.0 -180.0</TopLeftCorner>
        <TileWidth>256</TileWidth>
        <TileHeight>256</TileHeight>
        <MatrixWidth>4</MatrixWidth>
        <MatrixHeight>2</MatrixHeight>
    </TileMatrix>

    level:1
    resolution = 360/(256*2**1) = 0.703125

    level:2
    resolution = 360/(256*2**2) = 0.3515625


```

:::


### å‚è€ƒ  

[ArcGIS API for Javascript 4.5 åŠ è½½å¤©åœ°å›¾WMTSæœåŠ¡ç¤ºä¾‹ ](https://github.com/baxtergu/arcgis-jsapi4-load-tianditu-wmts-service)  

---




















