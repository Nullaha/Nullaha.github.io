---
sidebar_position: 2
title: arcgisjs4åŠ è½½geoserverçš„vectorTile
description: arcgisjs4åŠ è½½geoserverçš„vectorTile
date: 2024-6-28

tags: [arcgis for js4, gis, wmts, geoserver]
---

## ç›®çš„  

å‰ç«¯ä½¿ç”¨arcgis for js4 è®¿é—®GeoServerå‘å¸ƒçš„çŸ¢é‡åˆ‡ç‰‡æœåŠ¡ã€‚

## 1 arcgis for js4 åŠ è½½å®ƒå¹¶åœ¨åœ°å›¾ä¸Šå±•ç¤º   

### å…¨éƒ¨ä»£ç   

```js title='ä½¿ç”¨VectorTileLayer.js'
import VectorTileLayer from "@arcgis/core/layers/VectorTileLayer.js";

const lconfig = {
  layerId:'2',
  name: 'æµ‹è¯•_geoserver_vectorTile',
  urlTemplate:'http://xxx.xxx.x.xxx:xxxx/geoServer/gwc/service/wmts/rest/å‘½åç©ºé—´:å›¾å±‚åtest_abc/EPSG:4490/EPSG:4490:{z}/{y}/{x}?format=application/vnd.mapbox-vector-tile',
  // geoserver ä¸Šçš„å›¾å±‚å(ä¸éœ€è¦å¸¦å‘½åç©ºé—´)
  layerTable:'test_abc', 

}

const param = {
  id: lconfig.layerId,
  title:lconfig.name,
  style:{
    id:lconfig.id,
    version:8,
    sources:{
      abc:{
        type:'vector',
        'capabilities':'TileOnly',
        tiles:[
          lconfig.urlTemplate,
        ],
        // initialExtent: tileInfo4490Size512Meta.initialExtent, // éå¿…å¡«
        // fullExtent: tileInfo4490Size512Meta.fullExtent,       // éå¿…å¡«
        tileInfo:{
          ...tileInfo4490Size512, 
          // format:'pbf',
        }
      }

    },
    layers:[
      {
        id:lconfig.name+'a', //è¿™ä¸ªå¯ä»¥éšä¾¿å†™
        source:'abc',
        'source-layer':lconfig.layerTable, //è¿™ä¸ªå¿…é¡»æ˜¯geoserverä¸Šçš„å›¾å±‚åï¼ˆä¸éœ€è¦å¸¦å‘½åç©ºé—´ï¼‰ 
        // minzoom:0,  // éå¿…å¡«  è¿™ä¸ªåªæ˜¯æ§åˆ¶å®ƒçš„æ˜¾ç¤ºéšè—
        // maxzoom:24,  // éå¿…å¡«  è¿™ä¸ªåªæ˜¯æ§åˆ¶å®ƒçš„æ˜¾ç¤ºéšè—ï¼Œè¿˜æ˜¯ä¼šå»è¯·æ±‚18çº§çš„tileçš„ï¼Œåªæ˜¯ä¸ä¼šæ˜¾ç¤ºåœ¨åœ°å›¾ä¸Šã€‚
        type: "fill",
        paint: {
          "fill-color": "#00ff00",
          "fill-outline-color": "#ff0000",
        },
    
      }
    ]
  },
}
new VectorTileLayer(param)
```
[tileInfo4490Size512](/sourceCode/tileInfo/4490Size512.js)


### æ•ˆæœ  

![æ•ˆæœ](./img/åŠ è½½vectorTile/æ•ˆæœ.png)


## åä¸‡ä¸ªä¸ºä»€ä¹ˆ???    


### 1. é˜…è¯»VectorTileLayer æ–‡æ¡£ 

ç½‘ä¸Šå†™çš„äº”èŠ±å…«é—¨çš„ã€‚   

[VectorTileLayerå®˜æ–¹æ–‡æ¡£](https://developers.arcgis.com/javascript/latest/api-reference/esri-layers-VectorTileLayer.html#url)å†™çš„å¾ˆå¥½ï¼Œä¸è¦ä¸€ä¸Šæ¥å°±å»ç½‘ä¸Šçæœï¼ï¼ï¼  

#### Overview

> Overview  
>> How the VectorTileLayer displays is defined by the [MapLibre style specification](https://maplibre.org/maplibre-style-spec/).  
>> VectorTileLayer style information is stored separately from its tiles.  
>> This means that one set of vector tiles may be styled in numerous ways without having to generate a new image cache for each style.  
>> This helps save space and speeds up the process of creating new map styles.   

ğŸ‘†çŸ¢é‡åˆ‡ç‰‡å›¾å±‚çš„æ ·å¼å’Œåˆ‡ç‰‡æ˜¯åˆ†å¼€ä¿å­˜çš„ã€‚ï¼ˆä¹Ÿå°±æ˜¯åˆ‡ç‰‡ä¸åŒ…æ‹¬æ ·å¼ï¼Œä½ è¦è‡ªå·±å†™æ ·å¼ï¼‰  

#### Creating a VectorTileLayer

> Creating a VectorTileLayer
>> VectorTileLayers may be created in one of three ways: 
>> from a URL (either a service URL or a style URL),   
>> an ArcGIS portal item ID,   
>> or a JSON style object.  


#### style  

> style  
>> A style JSON object of vector tiles that will be used to render the layer.   
>> If initializing the layer with a style JSON object, the tiles are fetched from the tile servers specified in the style object.  


å®ƒè¿˜å†™äº†å‡ ä¸ªåˆ›å»ºçš„ä¾‹å­,çœ‹èµ·æ¥from style objectåƒæ˜¯ç”¨çš„æ˜¯ç¬¬ä¸‰æ–¹çŸ¢é‡åˆ‡ç‰‡æœåŠ¡ã€‚    

![from_style_object](./img//åŠ è½½vectorTile/from_style_object.png)  



### 2. `a JSON style object` åº”è¯¥æ€ä¹ˆå†™?  

[å‚è€ƒ1: MapLibre style specification](https://maplibre.org/maplibre-style-spec/)

[å‚è€ƒ2: ArcGIS Vector Tile Style Editor](https://www.arcgis.com/apps/vtseditor/en/#/styles)  


```js title='ç®€å•.js'
const style = {
  // id:configData.id,
  version:8,
  sources:{
    abc:{
      type:'vector',
      tiles:[
        configData.urlTemplate,
      ],
      // initialExtent: tileInfo4490Size512Meta.initialExtent,
      // fullExtent: tileInfo4490Size512Meta.fullExtent,
      tileInfo:{
        ...tileInfo4490Size512,
        // format:'pbf',
      }
    }

  },
  layers:[
    {
      id:configData.name+'a', //Unique layer name
      type: "fill",
      paint: {
        "fill-color": "#00ff00",
        "fill-outline-color": "#ff0000",
      },
      'source-layer':configData.layerTable, //è¿™ä¸ªå¿…é¡»æ˜¯geoserverä¸Šçš„å›¾å±‚åï¼ˆä¸éœ€è¦å¸¦å‘½åç©ºé—´ï¼‰
      source:'abc', // è¦å’Œstyle>sources.abcå¯¹åº”ï¼šName of a source description to be used for this layer. Required for all layer types except background.
      // minzoom:0,  // è¿™ä¸ªåªæ˜¯æ§åˆ¶å®ƒçš„æ˜¾ç¤ºéšè—
      // maxzoom:24,  // è¿™ä¸ªåªæ˜¯æ§åˆ¶å®ƒçš„æ˜¾ç¤ºéšè—ï¼Œè¿˜æ˜¯ä¼šå»è¯·æ±‚18çº§çš„tileçš„ï¼Œåªæ˜¯ä¸ä¼šæ˜¾ç¤ºåœ¨åœ°å›¾ä¸Šã€‚
    },
  ]
}

``` 


![æ•ˆæœ](./img/åŠ è½½vectorTile/æ•ˆæœ.png)  



***é‡Œé¢æœ‰å¾ˆå¤šæ³¨æ„çš„ç‚¹***  
æ€ä¹ˆæ‹¿urlTemplate?  

tileInfo? 

minzoom,maxzoom,source-layer,source éƒ½æ˜¯å•¥?  



### 3. æ€ä¹ˆæ‹¿urlTemplate?  


#### 1 ~~å»geoserverçš„åˆ‡ç‰‡å›¾å±‚ ç‚¹é¢„è§ˆæ‹¿è¯·æ±‚~~ã€‚  

![pbf](./img/åŠ è½½vectorTile/vector_tile_pbf.png)  

```md 
http://xxx.xxx.x.xxx:xxxx/geoServer/gwc/service/wmts?REQUEST=GetTile&SERVICE=WMTS&VERSION=1.0.0&LAYER=å‘½åç©ºé—´:å›¾å±‚åtest_abc&STYLE=&TILEMATRIX=EPSG:4490:{level}&TILEMATRIXSET=EPSG:4490&FORMAT=application/vnd.mapbox-vector-tile&TILECOL={col}&TILEROW={row}

```

#### 2 å» wmts capabilitiesæ‰¾   

```md
<ResourceURL format="application/vnd.mapbox-vector-tile" resourceType="tile" template="http://xxx.xxx.x.xxx:xxxx/geoServer/gwc/service/wmts/rest/å‘½åç©ºé—´:å›¾å±‚åtest_abc/{style}/{TileMatrixSet}/{TileMatrix}/{TileRow}/{TileCol}?format=application/vnd.mapbox-vector-tile"/>

<!-- {style} -->
vector tileçš„æ ·å¼è¦è‡ªå·±å†™ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥å¿½ç•¥å®ƒ

{TileMatrixSet}

EPSG:4490

{TileMatrix}

EPSG:4490:0

{TileMatrix}/{TileRow}/{TileCol}

EPSG:4490:{z}/{y}/{x}


<!-- æœ€ç»ˆï¼š -->
http://xxx.xxx.x.xxx:xxxx/geoServer/gwc/service/wmts/rest/å‘½åç©ºé—´:å›¾å±‚åtest_abc/EPSG:4490/EPSG:4490:{z}/{y}/{x}?format=application/vnd.mapbox-vector-tile

```

#### 3 æ€»ç»“

[å‚è€ƒï¼šArcGIS for JavaScript åŠ è½½ GeoServer çŸ¢é‡åˆ‡ç‰‡æœåŠ¡](https://www.cnblogs.com/lqqgis/p/17965476)  

è¿™ä¸ªå‚è€ƒé‡Œç”¨çš„urlTemplateæ˜¯é€šè¿‡geoserveré¢„è§ˆæ‹¿çš„ï¼Œä½¿ç”¨çš„æ—¶å€™ä¼šæŠ¥é”™ï¼Œæ— æ³•è§£æ`{z}`  
ä»–è®¤ä¸ºæ˜¯ç‰ˆæœ¬é—®é¢˜ï¼Œä¸”æ¢äº†arcgis for4çš„ç‰ˆæœ¬æœ‰æˆåŠŸï¼Œæœ‰å¤±è´¥ã€‚  
æˆ‘æ ¹æ®ä»–çš„æ“ä½œæ¢äº†ä¸€ä¸ªç‰ˆæœ¬ï¼Œè¿˜æ˜¯æ— æ³•åŠ è½½æˆåŠŸã€‚  

æ‰€ä»¥æˆ‘ç”¨çš„ capabilitiesé‡Œæ‰¾çš„url å¾ˆä¸æ»‘ã€‚  

### 4 tileInfo?   

#### æ”¾çš„ä½ç½®?  

æˆ‘çœ‹äº† styleæ–‡æ¡£çš„style.sourcesä¸­å¹¶æ²¡æœ‰tileInfoå±æ€§ã€‚  

æˆ‘çœ‹ VectorTileLayeræ–‡æ¡£æœ‰tileInfoè¿™ä¸ªå±æ€§ã€‚  

æˆ‘å°è¯•æŠŠtileInfoæ‹¿å‡ºæ¥ï¼ŒæŠ¥é”™ï¼  

```js 
new VectorTileLayer({
  id:'id',
  title:'title',
  tileInfo:{
    // ...
  },
  style:{
    // ...
  }
})

``` 

![VectorTileLayer.tileInfo](./img/åŠ è½½vectorTile/tileInfo.png)    

æ‰€ä»¥å®ƒè¿˜æ˜¯è€è€å®å®æ”¾åˆ°style.sourcesé‡Œå§ã€‚  

#### 256è¿˜æ˜¯512?   

[256](/sourceCode/tileInfo/4490.js)  
[512](/sourceCode/tileInfo/4490Size512.js)  

ç”¨256ä¼šå¯¼è‡´ä½ç½®åç§»ã€‚  

![ç”¨256çš„ä½ç½®](./img/åŠ è½½vectorTile/ç”¨256çš„ä½ç½®.png)  

#### ä¸ºä»€ä¹ˆä¸€å®šè¦512?   

æˆ‘å…¨ç½‘æœç´¢äº†....  

[å‚è€ƒï¼šarcgisçš„create-vector-tile-index](https://pro.arcgis.com/en/pro-app/latest/tool-reference/data-management/create-vector-tile-index.htm)  
>Existingâ€”The tiling scheme from an existing vector tile service will be used. Only tiling schemes with scales that double in progression through levels and have 512-by-512 tile size are supported. You must specify a vector tile service or tiling scheme file in the tiling_scheme parameter.  

[å‚è€ƒ:What is the expected size of a single Mapbox Vector Tile in Pixels?](https://stackoverflow.com/questions/65443769/what-is-the-expected-size-of-a-single-mapbox-vector-tile-in-pixels)  

TODO  
[â­å‚è€ƒï¼šWhat is a root tile and how are they used to make a vector tile package with a local coordinate system?](https://support.esri.com/en-us/knowledge-base/faq-what-is-a-root-tile-and-how-are-they-used-to-make-a-000022396)  

ğŸ‘†è¿˜ç»™ä½ è®¡ç®—çš„å…¬å¼.  
[World_Topo_Map (MapServer)](https://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer)


[å‚è€ƒï¼š00252: Tiling scheme is not supported for vector tile layers](https://pro.arcgis.com/en/pro-app/latest/help/sharing/analyzer-error-messages/00252-tiling-scheme-is-not-supported-for-vector-tile-layers.html)  





### 5 styleä¸­çš„å…¶å®ƒå±æ€§?  

#### minzoom,maxzoom  

éå¿…å¡«  

åªæ˜¯æ§åˆ¶å›¾å±‚åœ¨åº•å›¾ä¸Šçš„æ˜¾ç¤ºéšè—ã€‚ 
minzoomçº§ä»¥ä¸‹ä¸æ˜¾ç¤ºï¼Œ maxzoomä»¥ä¸Šä¸æ˜¾ç¤ºã€‚  
æ”¾å¤§ç¼©å°åœ°å›¾çš„zoomï¼Œå®ƒè¿˜æ˜¯ä¼šå»è¯·æ±‚æŸçº§çš„tileçš„ï¼Œåªæ˜¯ä¸ä¼šæ˜¾ç¤ºåœ¨åœ°å›¾ä¸Šã€‚  

#### 


### 6 è°ƒæ•´å®ƒçš„æ ·å¼?   

#### æ ¹æ®å›¾å±‚çš„æŸä¸ªå­—æ®µæ¥è®¾ç½®ä¸åŒçš„é¢œè‰²?   

fill-colorå†™æˆæ•°ç»„çš„æ ·å­ã€‚  

![æ ·å¼](./img//åŠ è½½vectorTile/æ ·å¼1.png)  

```js 
const style.layers = [
  {
    id:configData.name+'a', //è¿™ä¸ªå¯ä»¥éšæ„å†™
    type: "fill",
    paint: {
      // "fill-color": "#00ff00",
      "fill-color":[
        "match",
        ["get", "DJ"],
        "å°1å‹","#ff0000",
        "ä¸­å‹", "#00ff00",
        "å¤§å‹", "#0000ff",
        "#cccccc" // é»˜è®¤å¡«å……é¢œè‰²

      ],
    },
    'source-layer':configData.layerTable, 
    source:'abc',
  }
]

```

![æ•ˆæœ](./img/åŠ è½½vectorTile/æ•ˆæœ2.png)   





## å‚è€ƒ  

[ArcGIS JS 4åŠ è½½ç¬¬ä¸‰æ–¹çŸ¢é‡åˆ‡ç‰‡](https://juejin.cn/post/6844904015822602248)  
[Is it possible to add vector tile layer published by GeoServer layer using ArcGIS JS APIï¼Ÿ](https://gis.stackexchange.com/questions/300398/is-it-possible-to-add-vector-tile-layer-published-by-geoserver-layer-using-arcgi)


